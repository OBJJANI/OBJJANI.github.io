<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="" type="" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="jquery.js" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>
    <title>LOGIN RLX</title>
</head>

<body>
    <div class="loginBox"> <img class="user" src="img/profil.png" height="100px" width="100px">
        <h3>Connexion</h3>
        <div class="inputBox"> <input id="uname" type="email" name="Username" placeholder="Gmail"> <input id="pass"
                type="password" name="Password" placeholder="Password">
        </div> 
        <input type="button" name="" value="Login" id="lgn">
        <div class="text-center" id="err" style="color: white;">

        </div>
    </div>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyCKxxKkZ98Jmnb6IScolTyEepUwefNgviA",
            authDomain: "read-incoming-sms.firebaseapp.com",
            databaseURL: "https://read-incoming-sms.firebaseio.com",
            projectId: "read-incoming-sms",
            storageBucket: "read-incoming-sms.appspot.com",
            messagingSenderId: "591114501905",
            appId: "1:591114501905:web:b8d69a05ef337c07"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();
        var ref = firebase.database().ref('testers');
        var childData;
        //$(document).ready(function () {

        $('#lgn').click(function (event) {
            var count;
            var mac = navigator.userAgent;
            var gml = $('#uname').val();
            var pwd = $('#pass').val();
            var validRegex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            if (gml.match(validRegex) && pwd != '') {

                ref.on('value', function (snapshot) {
                    // childData = null;
                    count = 3;
                    snapshot.forEach(function (childSnapshot) {

                        childData = childSnapshot.val();
                        if (childData.login == gml && childData.pass == pwd && childData.mac == mac && childData.etat == "v") {

                            count = 1;
                        // console.log(childData);
                        //   console.log(count);
                        }
                        else if (childData.login == gml && childData.pass == pwd && childData.mac == mac && childData.etat == "nv") {

                            count = 2;
                          //  console.log(childData);
                          //  console.log(count);
                        }
                        

                        //console.log(childData);
                    });

                    //console.log(count);

                    if (count == 1) {
                        document.location.href = 'choix.html';

                    }
                    if (count == 2) {
                        $('#err').empty();
                        $('#err').append("Merci de patienter la validation de votre compte");

                    }
                    else if (count == 3) {
                        var rootRef = firebase.database().ref();
                        var storesRef = rootRef.child('testers');
                        var newStoreRef = storesRef.push();
                        newStoreRef.set({
                            "etat": "nv",
                            "login": gml,
                            "mac": mac,
                            "pass": pwd
                        });
                        $('#err').empty();
                        $('#err').append("Merci de patienter la validation de votre compte");

                    }


                });
                //





            } else {
                $('#err').empty();
                $('#err').append("Merci de remplir les champs");

            }

        });
      //  });



    </script>
</body>

</html>